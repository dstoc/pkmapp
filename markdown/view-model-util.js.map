{"version":3,"file":"view-model-util.js","sourceRoot":"","sources":["../../src/markdown/view-model-util.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2022 Google LLC\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {assert, cast} from '../asserts.js';\n\nimport {ViewModelNode} from './view-model.js';\nimport {MarkdownNode} from './node.js';\n\nexport function swapNodes(node1: ViewModelNode, node2: ViewModelNode) {\n  if (node1.viewModel.nextSibling === node2) {\n    node2.viewModel.insertBefore(cast(node1.viewModel.parent), node1);\n    return;\n  }\n  if (node2.viewModel.nextSibling === node1) {\n    node1.viewModel.insertBefore(cast(node2.viewModel.parent), node2);\n    return;\n  }\n  const node1Parent = node1.viewModel.parent!;\n  const node1NextSibling = node1.viewModel.nextSibling;\n  node1.viewModel.insertBefore(cast(node2.viewModel.parent), node2);\n  node2.viewModel.insertBefore(node1Parent, node1NextSibling);\n}\n\nexport function* ancestors(node: ViewModelNode, root: ViewModelNode) {\n  while (node.viewModel.parent) {\n    yield node.viewModel.parent;\n    node = node.viewModel.parent;\n    if (node === root) return;\n  }\n}\n\nexport function* reverseDfs(node: ViewModelNode, limit?: ViewModelNode) {\n  function next(next?: ViewModelNode) {\n    return next && (node = next);\n  }\n  do {\n    while (next(node.viewModel.previousSibling)) {\n      while (next(node.viewModel.lastChild));\n      yield node;\n      if (node === limit) return;\n    }\n    if (next(node.viewModel.parent)) {\n      yield node;\n      if (node === limit) return;\n      continue;\n    }\n    return;\n  } while (true);\n}\n\nexport function* dfs(\n  node: ViewModelNode,\n  root: ViewModelNode = node.viewModel.tree.root\n) {\n  function next(next?: ViewModelNode) {\n    return next && next !== root.viewModel.parent && (node = next);\n  }\n  do {\n    yield node;\n    if (next(node.viewModel.firstChild)) continue;\n    if (next(node.viewModel.nextSibling)) continue;\n    do {\n      if (!next(node.viewModel.parent)) return;\n    } while (!next(node.viewModel.nextSibling));\n  } while (true);\n}\n\nexport function findAncestor(\n  node: ViewModelNode,\n  root: ViewModelNode,\n  type: string\n) {\n  const path = [node];\n  for (const ancestor of ancestors(node, root)) {\n    if (ancestor.type === type) {\n      return {\n        ancestor,\n        path,\n      };\n    }\n    path.unshift(ancestor);\n  }\n  return {};\n}\n\ntype Editable = ViewModelNode & {type: 'paragraph' | 'code-block' | 'section'};\n\nfunction editable(node: ViewModelNode): node is Editable {\n  return ['paragraph', 'code-block', 'section'].includes(node.type);\n}\n\nexport function findPreviousEditable(\n  node: ViewModelNode,\n  root: ViewModelNode,\n  include = false\n) {\n  if (include && editable(node)) return node;\n  return findPreviousDfs(node, root, editable);\n}\n\nexport function findNextEditable(\n  node: ViewModelNode,\n  root: ViewModelNode,\n  include = false\n) {\n  if (include && editable(node)) return node;\n  return findNextDfs(node, root, editable);\n}\n\nexport function findFinalEditable(node: ViewModelNode, include = false) {\n  let result: Editable | null = null;\n  if (include && editable(node)) result = node;\n  for (const next of dfs(node)) {\n    if (editable(next)) result = next;\n  }\n  return result;\n}\n\nexport function findNextDfs<T extends ViewModelNode>(\n  node: ViewModelNode,\n  root: ViewModelNode,\n  predicate: (node: ViewModelNode) => node is T\n) {\n  for (const next of dfs(node, root)) {\n    if (next !== node && predicate(next)) return next;\n  }\n  return null;\n}\n\nexport function findPreviousDfs<T extends ViewModelNode>(\n  node: ViewModelNode,\n  root: ViewModelNode,\n  predicate: (node: ViewModelNode) => node is T\n) {\n  for (const next of reverseDfs(node, root)) {\n    if (next !== node && predicate(next)) return next;\n  }\n  return null;\n}\n\nexport function* children(node: ViewModelNode) {\n  let next = node.viewModel.firstChild;\n  while (next) {\n    assert(next.viewModel.parent === node);\n    const child = next;\n    next = child.viewModel.nextSibling;\n    yield child;\n  }\n}\n\n/**\n * Returns the values of `nodes` with any nodes that are descendants of\n * others removed.\n */\nexport function removeDescendantNodes(nodes: ViewModelNode[]) {\n  const roots = new Set<ViewModelNode>(nodes);\n  for (const node of nodes) {\n    for (const ancestor of ancestors(node, node.viewModel.tree.root)) {\n      if (roots.has(ancestor)) {\n        roots.delete(node);\n        break;\n      }\n    }\n  }\n  return [...roots.values()];\n}\n\nfunction* cloneChildren(\n  children: ViewModelNode[],\n  predicate?: (node: ViewModelNode) => boolean\n): Generator<MarkdownNode> {\n  for (const child of children) {\n    if (!predicate || predicate(child)) {\n      yield cloneNode(child, predicate);\n    }\n  }\n}\n\n/**\n * Clones `node` into a `MarkdownNode` excluding any descendants where the\n * optional predicate returns `false`.\n */\nexport function cloneNode(\n  node: ViewModelNode,\n  predicate?: (node: ViewModelNode) => boolean\n): MarkdownNode {\n  const result: MarkdownNode = {\n    ...node,\n    children: [...cloneChildren(node.children ?? [], predicate)],\n  };\n  delete (result as any).viewModel;\n  return result;\n}\n"]}