{"version":3,"file":"library.js","sourceRoot":"","sources":["../src/library.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2022 Google LLC\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {parseBlocks} from './markdown/block-parser.js';\nimport {serializeToString} from './markdown/block-serializer.js';\nimport {DocumentNode} from './markdown/node.js';\nimport {InlineViewModelNode, MarkdownTree, ViewModelNode} from './markdown/view-model.js';\nimport {Observe} from './observe.js';\nimport {BackLinks} from './backlinks.js';\nimport {Metadata} from './metadata.js';\nimport {assert, cast} from './asserts.js';\nimport {resolveDateAlias} from './date-aliases.js';\n\nexport interface Document {\n  refresh(): Promise<void>;\n  save(): Promise<void>;\n  readonly name: string;\n  readonly allNames: string[];\n  readonly tree: MarkdownTree;\n  readonly dirty: boolean;\n  readonly observe: Observe<Document>;\n}\n\nexport interface Library {\n  find(name: string): Promise<{document: Document, root: ViewModelNode}>;\n  getDocumentByTree(tree: MarkdownTree): Document|undefined;\n  getAllNames(): Promise<string[]>;\n  readonly backLinks: BackLinks;\n  readonly metadata: Metadata;\n  sync(): Promise<void>;\n}\n\nasync function*\n    allFiles(prefix: string, directory: FileSystemDirectoryHandle):\n        AsyncGenerator<string, void, unknown> {\n  for await (const entry of directory.values()) {\n    if (entry.kind === 'file' && entry.name.endsWith('.md')) {\n      yield prefix + entry.name.replace(/\\.md$/i, '');\n    } else if (entry.kind === 'directory') {\n      yield* allFiles(prefix + entry.name + '/', entry);\n    }\n  }\n}\n\nasync function getFileHandleFromPath(\n    directory: FileSystemDirectoryHandle, path: string, create = false) {\n  const parts = path.split('/');\n  const name: string = parts.pop()!;\n  for (const part of parts) {\n    directory = await directory.getDirectoryHandle(part, {create});\n  }\n  return directory.getFileHandle(name, {create});\n}\n\nexport class FileSystemLibrary implements Library {\n  constructor(private readonly directory: FileSystemDirectoryHandle) {}\n  async getAllNames(): Promise<string[]> {\n    const result = new Set<string>();\n    for (const document of this.cache.values()) {\n      for (const name of document.allNames) {\n        result.add(name);\n      }\n    }\n    for (const name of this.metadata.getAllNames()) {\n      result.add(name);\n    }\n    return [...result];\n  }\n  private cache: Map<string, Document> = new Map();\n  backLinks = new BackLinks();\n  metadata = new Metadata();\n  getDocumentByTree(tree: MarkdownTree): Document|undefined {\n    // TODO: index\n    for (const document of this.cache.values()) {\n      if (document.tree === tree) {\n        return document;\n      }\n    }\n    return undefined;\n  }\n  async sync() {\n    for await (const name of allFiles('', this.directory)) {\n      const document = await this.loadDocument(name);\n      await document.refresh();\n    }\n  }\n  async find(name: string) {\n    name = resolveDateAlias(name) ?? name;\n    const root = this.metadata.findByName(name);\n    if (root) {\n      const document = cast(this.getDocumentByTree(root.viewModel.tree));\n      return {\n        document,\n        root, \n      };\n    } else {\n      const document = await this.loadDocument(name, true);\n      return {\n        document,\n        root: document.tree.root,\n      };\n    }\n  }\n  private async loadDocument(name: string, forceRefresh = false): Promise<Document> {\n    name = resolveDateAlias(name) ?? name;\n    const fileName = name + '.md';\n    const load = async (ifModifiedSince: number) => {\n      let text = '';\n      let lastModified = new Date().getTime();\n      try {\n        const handle = await getFileHandleFromPath(this.directory, fileName);\n        const file = await handle.getFile();\n        // TODO: also check that the content has actually changed\n        if (ifModifiedSince >= file.lastModified) return {lastModified: file.lastModified};\n        const decoder = new TextDecoder();\n        text = decoder.decode(await file.arrayBuffer());\n        lastModified = file.lastModified;\n      } catch (e) {\n        console.error(e);\n      }\n      const root = parseBlocks(text);\n      assert(root && root.type === 'document');\n      return {root, lastModified};\n    };\n    const aliased = this.metadata.findByName(name);\n    if (aliased) {\n      const document = this.getDocumentByTree(aliased.viewModel.tree);\n      return cast(document);\n    }\n    const cached = this.cache.get(name);\n    if (cached) {\n      if (forceRefresh) {\n        await cached.refresh();\n      }\n      return cached;\n    }\n    const {root, lastModified} = await load(0);\n    const library = this;\n    const result = new class implements Document {\n      constructor() {\n        this.lastModified = lastModified;\n        this.tree = new MarkdownTree(cast(root), this);\n        this.tree.observe.add(() => this.markDirty());\n      }\n      readonly tree: MarkdownTree;\n      lastModified: number;\n      dirty = false;\n      observe: Observe<Document> = new Observe<Document>(this);\n      get name() {\n        return this.allNames[0];\n      }\n      get allNames() {\n        return [\n          ...library.metadata.getNames(this.tree.root),\n          name,\n        ];\n      }\n      postEditUpdate(node: ViewModelNode, change: 'connected'|'disconnected'|'changed') {\n        if (node.type === 'paragraph') {\n          library.backLinks.postEditUpdate(node as InlineViewModelNode, change);\n        }\n        if (node.type === 'code-block') {\n          library.metadata.updateCodeblock(node, change);\n        }\n        if (node.type === 'section') {\n          library.metadata.updateSection(node, change);\n        }\n      }\n      async refresh() {\n        const {root, lastModified} = await load(this.lastModified);\n        if (root) {\n          this.lastModified = lastModified;\n          this.tree.setRoot(this.tree.add<DocumentNode>(root));\n          this.tree.observe.notify();\n        }\n      }\n      async save() {\n        const text = serializeToString(this.tree.root);\n        const handle = await getFileHandleFromPath(library.directory, fileName, true);\n        const stream = await handle.createWritable();\n        await stream.write(text);\n        await stream.close();\n        this.lastModified = new Date().getTime();\n      }\n      private pendingModifications = 0;\n      async markDirty() {\n        // TODO: The tree could be in an inconsistent state, don't trigger the\n        // the observer until the edit is finished, or wait for normalization.\n        await 0;\n        this.dirty = true;\n        this.observe.notify();\n        if (this.pendingModifications++) return;\n        while (true) {\n          const preSave = this.pendingModifications;\n          // Save immediately on the fist iteration, may help keep tests fast.\n          await this.save();\n          if (this.pendingModifications === preSave) {\n            this.pendingModifications = 0;\n            this.dirty = false;\n            this.observe.notify();\n            return;\n          }\n          // Wait for an idle period with no modifications.\n          let preIdle = NaN;\n          do {\n            preIdle = this.pendingModifications;\n            // TODO: maybe a timeout is better?\n            await new Promise((resolve) => requestIdleCallback(resolve));\n          } while (preIdle != this.pendingModifications);\n        }\n      }\n    };\n    this.cache.set(name, result);\n    return result;\n  }\n}\n"]}