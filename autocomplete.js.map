{"version":3,"file":"autocomplete.js","sourceRoot":"","sources":["../src/autocomplete.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 Google LLC\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport './markdown/block-render.js';\nimport './command-palette.js';\n\nimport {contextProvided} from './deps/lit-labs-context.js';\nimport {libraryContext} from './app-context.js';\nimport {css, query, customElement, html, LitElement, property, state} from './deps/lit.js';\nimport {InlineKeyDown} from './markdown/inline-render.js';\nimport {InlineViewModelNode} from './markdown/view-model.js';\nimport {MarkdownInline} from './markdown/inline-render.js';\nimport {Command, CommandPalette} from './command-palette';\nimport {focusNode} from './markdown/host-context.js';\nimport {Library} from './library.js';\n\n@customElement('pkm-autocomplete')\nexport class Autocomplete extends LitElement {\n  static override get styles() {\n    return css`\n      :host {\n        display: none;\n      }\n      :host([state='active']) {\n        display: block;\n        position: absolute;\n        top: var(--y);\n        left: var(--x);\n        color: var(--root-color);\n        margin-top: 5px;\n        background: var(--pkm-dialog-bgcolor);\n        border: 3px solid var(--md-accent-color);\n        border-radius: 10px;\n        width: 500px;\n        display: grid;\n        padding: 0;\n      }\n    `;\n  }\n  @query('pkm-command-palette') palette!: CommandPalette;\n  @property({reflect: true})\n  private state: 'active'|'inactive' = 'inactive';\n  node?: InlineViewModelNode;\n  startIndex: number = 0;\n  @state()\n  endIndex: number = 0;\n  @contextProvided({context: libraryContext, subscribe: true})\n  @state()\n  library!: Library;\n  override render() {\n    return html`\n      <pkm-command-palette @commit=${this.abort} no-header></pkm-command-palette>\n    `;\n  }\n  onInlineKeyDown({\n    detail: {inline, node, keyboardEvent},\n  }: CustomEvent<InlineKeyDown>) {\n    if (this.state !== 'active') return false;\n    if (keyboardEvent.key === 'ArrowUp') {\n      this.palette.previous();\n      keyboardEvent.preventDefault();\n      return true;\n    } else if (keyboardEvent.key === 'ArrowDown') {\n      this.palette.next();\n      keyboardEvent.preventDefault();\n      return true;\n    } else if (['Tab', 'Enter'].includes(keyboardEvent.key)) {\n      this.palette.commit();\n      keyboardEvent.preventDefault();\n      return true;\n    } else if (['ArrowLeft', 'ArrowRight', 'Escape'].includes(keyboardEvent.key)) {\n      this.abort();\n    }\n    return false;\n  }\n  abort() {\n    this.state = 'inactive';\n    this.startIndex = 0;\n    this.endIndex = 0;\n    this.node = undefined;\n  }\n  activate(inline: MarkdownInline, index: number) {\n    const {x, y} = inline.getCaretPosition();\n    this.style.setProperty('--x', x + 'px');\n    this.style.setProperty('--y', y + 'px');\n    this.state = 'active';\n    this.node = inline.node!;\n    this.startIndex = index;\n    this.endIndex = index;\n    document.addEventListener('pointerdown', () => this.abort(), {capture: true, once: true});\n  }\n  private getLinkInsertionCommand(inline: MarkdownInline) {\n    const node = inline.node!;\n    const execute = async (arg?: string): Promise<Command[]> => {\n      const finish = node.viewModel.tree.edit();\n      try {\n        const newEndIndex = this.startIndex + arg!.length;\n        node.viewModel.edit({\n          startIndex: this.startIndex,\n          newEndIndex,\n          oldEndIndex: this.endIndex,\n          newText: arg!,\n        });\n        focusNode(inline.hostContext!, inline.node!, newEndIndex + 1);\n      } finally {\n        finish();\n      }\n      return [];\n    };\n    return {\n      execute: async () => (await this.library!.getAllNames()).map(name => ({\n        description: name,\n        execute: () => execute(name), \n      })),\n      executeFreeform: execute,\n      description: 'Link',\n    };\n  }\n  getSlashCommandWrapper(inline: MarkdownInline, command: Command) {\n    const node = inline.node!;\n    return {\n      execute: async () => {\n        node.viewModel.edit({\n          // TODO: numbers are too contextual\n          startIndex: this.startIndex - 1,\n          newEndIndex: this.startIndex + 2,\n          oldEndIndex: this.endIndex,\n          newText: '[]',\n        });\n        this.endIndex = this.startIndex;\n        focusNode(inline.hostContext!, node!, this.startIndex);\n        return command.execute();\n      },\n      description: command.description,\n    };\n  }\n\n  onInlineEdit(inline: MarkdownInline, newText: string, cursorIndex: number) {\n    const node = inline.node;\n    if (!node) return;\n    if (this.node !== node || cursorIndex < this.startIndex) {\n      this.abort();\n    }\n    if (this.state === 'inactive') {\n      if (newText === '[') {\n        this.activate(inline, cursorIndex);\n        node.viewModel.edit({\n          startIndex: cursorIndex,\n          newEndIndex: cursorIndex + 1,\n          oldEndIndex: cursorIndex,\n          newText: ']',\n        });\n        this.palette.triggerArgument(this.getLinkInsertionCommand(inline));\n      } else if (newText === '/') {\n        this.palette.trigger([this.getSlashCommandWrapper(inline, this.getLinkInsertionCommand(inline))]);\n        this.activate(inline, cursorIndex);\n      }\n    } else if (newText === ']') {\n      const finish = node.viewModel.tree.edit();\n      try {\n        node.viewModel.edit({\n          startIndex: cursorIndex - 1,\n          newEndIndex: cursorIndex - 1,\n          oldEndIndex: cursorIndex,\n          newText: '',\n        });\n      } finally {\n        finish();\n      }\n      this.abort();\n    } else {\n      this.endIndex = cursorIndex;\n    }\n    if (this.state === 'active') {\n      this.palette.setInput(node.content.substring(this.startIndex, this.endIndex));\n    }\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'pkm-autocomplete': Autocomplete;\n  }\n}\n"]}